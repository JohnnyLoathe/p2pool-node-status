<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>P2Pool Node Status - Share</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap-theme.min.css">

    <script type="text/javascript" src="d3.v2.min.js"></script>

    <script src="js/jquery-2.0.3.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery-dateFormat.min.js"></script>

    <script src="js/util.js"></script>
    <script src="js/charts.js"></script>

    <script src="js/config.json"></script>
    <script src="js/init.js"></script>

    <!-- Custom styles for this template -->
    <link href="css/p2pool-node-status.css" rel="stylesheet">

    <style type="text/css">
      body {
        font-family: 'Roboto', Helvetica, sans-serif;
        font-size: 13px;
        margin-top: 10px;
      }
      #myModal .modal-dialog {
        width: 70%;/* your width */
      }
    </style>

    <style type="text/css">
        line {
            stroke: black;
            stroke-width: 1;
            shape-rendering: crispEdges;
        }
        
        .plotline {
            stroke-width: 1.4;
            fill: none;
        }
        
        text {
            font-family: Sans-serif;
            font-size: 12px;
        }

        #miner-summary table table td:first-child {
          font-weight: bold;
          width: 185px;
        }

        #miner-summary {
          margin-bottom: 20px;
        }
    </style>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <div id='header'></div>

    <div class="container">
      <div class="page-header">
        <h1 id="page-title"></h1>
        <b>
          <small>
            <span id='_node' class='hidden'>Node: </span>
            <span id='node' class='hidden'></span><br/>
            <span id='updated'></span>
          </small>
        </b>
      </div>

      <div id="loading"><span>Loading...</span></div>

      <div id="local_rate_graph"></div>

      <div class="text-center" id="periods">
        <div>
          Periods: <span id="period_chooser"></span>
        </div>

        <div>
          Current: <span id="period_current"></span>
        </div>
      </div>

      <br/>

      <div id="miner-summary">
        <h4>Miner Summary</h4>

        <table class="table table-hover" border='0'>
          <tr>
            <td width="25%">Hashrate</td>
            <td id="hashrate"></td>
            <td width="25%">Address</td>
            <td id="address"></td>
          </tr>
          <tr>
            <td width="25%">DOA</td>
            <td id="doa"></td>
            <td width="25%">DOA %</td>
            <td id="doa_prop"></td>
          </tr>
          <tr>
            <td height="30">Predicted Payout</td>
            <td width="25%"><button class="to_usd"><span id="payout"></span></button></td>
            <td width="25%"></td>
            <td width="25%"></td>
          </tr>
        </table>
      </div>

      <div id="payout_graph"></div>

      <h4>Bitcoin Status</h4>
      <table class="table table-hover" border='0'>
        <tr>
          <td height="30">Total Received</td>
          <td width="25%"><button class="to_usd"><span id="total_received"></span></button></td>
          <td height="30">Total Sent</td>
          <td width="25%"><button class="to_usd"><span id="total_sent"></span></button></td>
        </tr>
        <tr>
          <td height="30">Current Balance</td>
          <td width="25%"><button class="to_usd"><span id="current_balance"></span></button></td>
          <td width="25%"></td>
          <td width="25%"></td>
        </tr>
      </table>

      <h4>Recent Pool Shares</h4>
      <table id='recent_shares' class="table table-hover">
        <thead>
          <th class="hidden">Timestamp</th>
          <th>Date/Time</th>
          <th>Hash</th>
          <th class="text-center">State</th>
        </thead>
        <tbody></tbody>
      </table>
    </div> <!-- /container -->

    <div id='footer'></div>

    <script type="text/javascript">
        var current_hash = null;
        var miner_hash = document.location.hash.substr(1);
        var currency_info;
        var local_stats, current_payouts;

        var h1 = d3.select('#page-title');
            h1.append('a').attr('href', '.').text('P2Pool Node Status');
            h1.append('span').text(' > Miner ' + miner_hash.substr(0,8));

        periods = ["Day", "Week", "Month", "Year"];
        d3.select("#period_chooser").selectAll().data(periods).enter().append("a")
            .text(function(period) { return period })
            .attr('href', function(period){ return "?" + period + "#" + miner_hash})
            .attr("style", function(d, i) { return (i == 0 ? "" : "margin-left:.4em;")});

        var period = window.location.search.substr(1);

        if(period.length < 3) {
            window.location.hash = miner_hash;
            window.location.search = "Day";
        } else if (miner_hash == "") {
            window.location = '/';
        } else {
            d3.json('../web/currency_info', function(currency_info_response) {
                currency_info = currency_info_response;
            });

            $.getJSON('/local_stats', function(data) {
              if(data) {
                local_stats = data;

                $.getJSON('/current_payouts', function(data) {
                  if(data) {
                    current_payouts = data;

                    loadStats();
                  }
                });
              }
            });

            loadGraphs();
            loadQr();
            loadMinerTransactions();
            loadRecentShares();
        }

        function loadStats() {
          d3.select('#address').text(miner_hash);

          hashrate = local_stats.miner_hash_rates[miner_hash];
          doa = local_stats.miner_dead_hash_rates[miner_hash] || 0;
          doa_prop = (parseFloat(doa) / parseFloat(hashrate)) * 100;
          payout = current_payouts[miner_hash] || 0;

          d3.select('#hashrate').text(formatHashrate(hashrate));
          d3.select('#doa').text(formatHashrate(doa));
          d3.select('#doa_prop').text(doa_prop.toFixed(2) + '%');

          if (payout) {
            $('#payout').attr('data-value', payout);
            d3.select('#payout').text(parseFloat(payout).toFixed(8).toString() + ' ' + currency_info.symbol);
          }
          else {
            d3.select('#payout').text('no shares yet');
          }
        }

        function loadGraphs() {
            var lowerperiod = period.toLowerCase();

            d3.select("#period_current").text(period);

            d3.json("../web/graph_data/miner_hash_rates/last_" + lowerperiod, function(data) {
                d3.json("../web/graph_data/miner_dead_hash_rates/last_" + lowerperiod, function(dead_data) {
                    d3.json("../web/graph_data/current_payouts/last_" + lowerperiod, function(current_payouts) {
                        d3.select("#loading").selectAll("*").remove();

                        var div = d3.select('#local_rate_graph').selectAll().data([miner_hash]).enter().append("div");
                        div.append('h3').text('Local Rate');
                        div.append("svg:svg").each(function(u) {
                            plot(d3.select(this), "H/s", "H", [
                                {"data": data.map(function(d){ return [d[0], u in d[1] ? d[1][u] : d[3], d[2]] }), "color": "#5bb75b", "label": "Total"},
                                {"data": dead_data.map(function(d){ return [d[0], u in d[1] ? d[1][u] : d[3], d[2]] }), "color": "#FF0000", "label": "Dead"}
                            ]);
                        });


                        var div = d3.select('#payout_graph').selectAll().data([miner_hash]).enter().append("div");
                        div.append('h3').text('Payout');
                        div.append("svg:svg").each(function(u) {
                            plot(d3.select(this), currency_info.symbol, null, [
                                {"data": current_payouts.map(function(d){ return [d[0], u in d[1] ? d[1][u] : d[3], d[2]] }), "color": "#5bb75b"}
                            ]);
                        });
                    });
                });
            });
        }

        function loadQr() {
          $('img#blockchain_qr').attr('src', 'https://blockchain.info/qr?data=' + miner_hash + '&size=200');
        }

        function loadMinerTransactions() {
          $.getJSON('https://blockchain.info/q/getreceivedbyaddress/' + miner_hash + '?cors=true', function(data) {
            var received_by_address = data;

            $.getJSON('https://blockchain.info/q/getsentbyaddress/' + miner_hash + '?cors=true', function(data) {
              var sent_by_address = data;

              $.getJSON('https://blockchain.info/q/addressbalance/' + miner_hash + '?cors=true', function(data) {
                var address_balance = data;

                $('#total_received')
                  .attr('data-value', satoshiToBTC(received_by_address))
                  .text(satoshiToBTC(received_by_address).toString() + ' BTC');

                $('#total_sent')
                  .attr('data-value', satoshiToBTC(sent_by_address))
                  .text(satoshiToBTC(sent_by_address).toString() + ' BTC');

                $('#current_balance')
                  .attr('data-value', satoshiToBTC(address_balance))
                  .text(parseFloat(satoshiToBTC(address_balance)).toString() + ' BTC');
              });
            });
          });
        }

        function loadRecentShares() {
          $.getJSON('/web/my_share_hashes', function(data) {
            recent_shares = data;

            $.each(recent_shares, function(key, share_hash) {
              var shareinfo;
              $.ajax('/web/share/' + share_hash, {
                  async: false,
                  success: function(data) {
                      if (data) {
                          shareinfo = data['share_data'];
                      }
                  }
              });

              if (!shareinfo) { return; }

              if (shareinfo['payout_address'] != miner_hash) {
                return;
              } else {
                var blockinfo= $('<a/>').attr('href', 'share.html#' + share_hash).text(share_hash);
                var stale_info = $('<span/>');
                if (shareinfo.stale_info == null) {
                  stale_info.addClass('green').text('valid');
                } else {
                  stale_info.addClass('red').text(shareinfo.stale_info);
                }

                tr= $('<tr/>').attr('id', share_hash);
                tr.append($('<td class="hidden"/>').text(shareinfo.timestamp));
                tr.append($('<td/>').text($.format.prettyDate(new Date(shareinfo.timestamp * 1000))));
                tr.append($('<td/>').append(blockinfo));
                tr.append($('<td/>').addClass('text-center').append(stale_info));
                $('#recent_shares tbody').append(tr);
              }
            });
          });
        }
    </script>
  </body>
</html>