<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>P2Pool Node Status - Share</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap-theme.min.css">

    <script type="text/javascript" src="d3.v2.min.js"></script>

    <script src="js/jquery-2.0.3.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery-dateFormat.min.js"></script>

    <script src="js/util.js"></script>
    <script src="js/charts.js"></script>

    <script src="js/config.json"></script>
    <script src="js/init.js"></script>

    <!-- Custom styles for this template -->
    <link href="css/p2pool-node-status.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
  </head>
    <body>
      <div id='header'></div>

    <div class="container">
      <div class="page-header">
        <div id="ad"></div>
        <h1 id="page-title"></h1>
        <b>
          <small>
            <span id='_node' class='hidden'>Node: </span>
            <span id='node' class='hidden'></span><br/>
            <span id='updated'></span>
          </small>
        </b>
      </div>

      <div id="share_data">
        <p>Loading...</p>
      </div>
    </div> <!-- /container -->

    <div id='footer'></div>

        <script type="text/javascript">
            function hex2a(hex) {
                var str = '';
                for (var i = 0; i < hex.length; i += 2) {
                    var code = parseInt(hex.substr(i, 2), 16);
                    str += code >= 32 && code <= 126 ? String.fromCharCode(code) : '?';
                }
                return str;
            }
            
            function target_to_difficulty(target) { return (0xffff0000 * Math.pow(2, 256-64) + 1)/(target + 1); }
            
            var current_hash = null;
            function reload(currency_info) {
                var share_hash = document.location.hash.substr(1);
                if(share_hash == current_hash) return;
                d3.json('../web/share/' + share_hash, function(share) {
                    current_hash = share_hash;
                    var b = d3.select('#share_data');
                    b.selectAll('*').remove();
                    var h1 = d3.select('#page-title');
                        h1.text('');
                        h1.append('a').attr('href', '.').text('P2Pool Node Status');
                        h1.append('span').text(' > Share ' + share_hash.substr(-8));
                    if(share == null) {
                        b.append('p').text('share not found');
                        return;
                    }
                    var parent = b.append('p')
                        parent.append('span').text('Parent: ');
                        parent.append('a').attr('href', '#' + share.parent).text(share.parent.substr(-8));
                    var children = b.append('p');
                        children.append('span').text('Children: ');
                        children.selectAll().data(share.children).enter().append('span').text(' ').append('a')
                            .attr('href', function(c){return '#' + c})
                            .text(function(c){return c.substr(-8)});

                    b.append('h2').text('Share data');
                    b.append('p').text('Timestamp: ' + new Date(1000*share.share_data.timestamp) + ' (' + share.share_data.timestamp + ')');
                    b.append('p').text('Difficulty: ' + target_to_difficulty(share.share_data.target));
                    b.append('p').text('Minimum difficulty: ' + target_to_difficulty(share.share_data.max_target));
                    b.append('p').text('Payout address: ').append('code').text(share.share_data.payout_address);
                    b.append('p').text('Donation amount: ' + d3.format('.3p')(share.share_data.donation));
                    b.append('p').text('Last stale: ' + share.share_data.stale_info);
                    b.append('p').text('Nonce: ' + share.share_data.nonce);
                    b.append('p').text('Desired version: ' + share.share_data.desired_version);
                    b.append('p').text('Absolute height: ' + share.share_data.absheight);
                    b.append('p').text('Absolute work: ' + share.share_data.abswork);

                    b.append('h2').text('Generation transaction');
                    b.append('p').text('Hash: ' + share.block.gentx.hash);
                    b.append('p').text('Coinbase (hex): ' + share.block.gentx.coinbase);
                    value = share.block.gentx.value;
                    b.append('p').html('Value: <button class="to_usd"><span data-value="'+value+'">' + value + ' ' + currency_info.symbol + '</span></button>');
                    b.append('p').text('Last txout nonce (used by Stratum miners): ' + share.block.gentx.last_txout_nonce);

                    b.append('h2').text('Local data');
                    b.append('p').text('Verified: ' + share.local.verified);
                    b.append('p').text('Time first seen: ' + new Date(1000*share.local.time_first_seen) + ' (' + share.local.time_first_seen + ')');
                    b.append('p').text('Peer first received from: ' + share.local.peer_first_received_from);
                    b.append('h2').text('Block');
                    var block = b.append('p')
                        block.append('span').text('Hash: ' + share.block.hash);
                    b.append('h3').text('Header');
                    b.append('p').text('Version: ' + share.block.header.version);
                    var prevblock = b.append('p')
                        prevblock.append('span').text('Previous block: ');
                        prevblock.append('a').attr('href', 'block.html#' + share.block.header.previous_block).text(share.block.header.previous_block);
                    b.append('p').text('Merkle root: ' + share.block.header.merkle_root);
                    b.append('p').text('Timestamp: ' + new Date(1000*share.block.header.timestamp) + ' (' + share.block.header.timestamp + ')');
                    b.append('p').text('Difficulty: ' + target_to_difficulty(share.block.header.target));
                    b.append('p').text('Nonce: ' + share.block.header.nonce);
                    bindCurrencyConversionButtons();
                    return true;
                });
            }
            
            d3.json('../web/currency_info', function(currency_info) {
                reload(currency_info);
                setInterval(function(){ reload(currency_info) }, 100);
            });
        </script>
    </body>
</html>
